<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>GPS with OpenLayers</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.4.0/ol.css?v={{version}}" />
<style>
body { margin:0; padding:0; font-family: Arial, sans-serif; }
#map { width: 100vw; height: 88vh; }
#controls {
  top: 10px;
  left: 0%;
  z-index: 1000;
  background: white;
  padding: 10px;
  border-radius: 8px;
}
header { padding: 8px; background:#222; color:white; display:flex; gap:8px; align-items:center; }
.btn { background:#2196f3; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
#route { padding: 10px; border-radius:8px; }
</style>
</head>
<body>

<header>
  <div><strong>GPS ‚Äî OpenLayers</strong></div>
  <button class="btn" id="btn-center">üìç Center</button>
  <button class="btn" id="btn-follow">‚ñ∂ Follow: OFF</button>

  <div id="controls">
    <input id="start" type="text" placeholder="My location">
    <input id="end" type="text" placeholder="Destination">
    <button id="route">Generate Route</button>
  </div>
</header>

<div id="map"></div>

<script src="https://cdn.jsdelivr.net/npm/ol@7.4.0/dist/ol.js?v={{version}}"></script>
<script>
/* your entire JS logic remains the same, only English translations below */

const map = new ol.Map({
  target: 'map',
  layers: [new ol.layer.Tile({ source: new ol.source.OSM() })],
  view: new ol.View({ center: ol.proj.fromLonLat([-46.633308, -23.55052]), zoom: 14 })
});

const vectorSource = new ol.source.Vector();
map.addLayer(new ol.layer.Vector({ source: vectorSource }));

const markerStyle = new ol.style.Style({
  image: new ol.style.Circle({
    radius: 8,
    fill: new ol.style.Fill({ color: '#ff5722' }),
    stroke: new ol.style.Stroke({ color: '#fff', width: 2 })
  })
});

const accuracyStyle = new ol.style.Style({
  fill: new ol.style.Fill({ color: 'rgba(33,150,243,0.1)' }),
  stroke: new ol.style.Stroke({ color: 'rgba(33,150,243,0.6)', width: 1 })
});

let markerFeature = null;
let accuracyFeature = null;
let watchId = null;
let following = false;
let currentPos = null;
let lat1 = null;
let lat2 = null;
let lon1 = null;
let lon2 = null;
let currentRoute = null;

const btnFollow = document.getElementById('btn-follow');

function updateStatus() {}

/* Position handling */
function handlePosition(pos) {
  const lat = pos.coords.latitude;
  const lon = pos.coords.longitude;
  const coord = ol.proj.fromLonLat([lon, lat]);
  currentPos = [lon, lat];

  if (!markerFeature) {
    markerFeature = new ol.Feature(new ol.geom.Point(coord));
    markerFeature.setStyle(markerStyle);
    vectorSource.addFeature(markerFeature);
  } else {
    markerFeature.getGeometry().setCoordinates(coord);
  }

  if (!accuracyFeature) {
    accuracyFeature = new ol.Feature(new ol.geom.Circle(coord, pos.coords.accuracy));
    accuracyFeature.setStyle(accuracyStyle);
    vectorSource.addFeature(accuracyFeature);
  } else {
    accuracyFeature.getGeometry().setCenter(coord);
    accuracyFeature.getGeometry().setRadius(pos.coords.accuracy);
  }

  if (following) {
    map.getView().animate({
      center: coord,
      zoom: Math.max(map.getView().getZoom(), 16),
      duration: 300
    });
  }
}

function handleError(err) {
  console.error(err);
}

function startWatching() {
  if (!('geolocation' in navigator)) return;
  watchId = navigator.geolocation.watchPosition(
    handlePosition,
    handleError,
    { enableHighAccuracy: true, maximumAge: 1000, timeout: 10000 }
  );
}

/* Remove previous route */
function removeRoute() {
  if (currentRoute) {
    map.removeLayer(currentRoute);
    currentRoute = null;
  }
}

/* Generate route */
document.getElementById("route").addEventListener("click", async () => {
  removeRoute();

  const origin = document.getElementById("start").value;
  const destination = document.getElementById("end").value;

  const o = await geocode(origin);
  const d = await geocode(destination);

  lat1 = o.pos1;
  lon1 = o.pos2;
  lat2 = d.pos1;
  lon2 = d.pos2;

  fetch('/rota', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ origem: [lon1, lat1], destino: [lon2, lat2] })
  })
  .then(r => r.json())
  .then(data => {
    const route = new ol.format.GeoJSON().readFeatures(data, {
      featureProjection: map.getView().getProjection()
    });

    const routeLayer = new ol.layer.Vector({
      source: new ol.source.Vector({ features: route }),
      style: new ol.style.Style({
        stroke: new ol.style.Stroke({ color: 'blue', width: 3 })
      })
    });

    currentRoute = routeLayer;
    map.addLayer(currentRoute);
  });
});

/* Click to generate manual route */
map.on('singleclick', evt => {
  const [lon2_val, lat2_val] = ol.proj.toLonLat(evt.coordinate);
  if (!currentPos) return alert("Current location not available yet.");

  if (lat1 === null || lon1 === null) {
    lat1 = currentPos[1];
    lon1 = currentPos[0];
  }

  let originCoord = null;

  if (document.getElementById("start").value.trim() !== "") {
    originCoord = [lon1, lat1];
  } else {
    originCoord = currentPos;
  }

  removeRoute();

  fetch('/rota', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ origem: originCoord, destino: [lon2_val, lat2_val] })
  })
  .then(r => r.json())
  .then(data => {
    const route = new ol.format.GeoJSON().readFeatures(data, {
      featureProjection: map.getView().getProjection()
    });

    const routeLayer = new ol.layer.Vector({
      source: new ol.source.Vector({ features: route }),
      style: new ol.style.Style({
        stroke: new ol.style.Stroke({ color: 'blue', width: 3 })
      })
    });

    currentRoute = routeLayer;
    map.addLayer(currentRoute);
  });
});

/* Geocoding */
async function geocode(address) {
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
  const response = await fetch(url);
  const data = await response.json();

  if (!data || data.length === 0) {
    throw new Error(`Address "${address}" not found`);
  }

  return {
    pos1: parseFloat(data[0].lat),
    pos2: parseFloat(data[0].lon)
  };
}

/* Initial center */
function getCurrentOnceAndStartWatch() {
  if (!('geolocation' in navigator)) return;

  navigator.geolocation.getCurrentPosition(
    pos => {
      handlePosition(pos);
      map.getView().animate({
        center: ol.proj.fromLonLat([pos.coords.longitude, pos.coords.latitude]),
        zoom: 16,
        duration: 400
      });
      startWatching();
    },
    handleError,
    { enableHighAccuracy: true, timeout: 10000 }
  );
}

document.getElementById('btn-center').addEventListener('click', () => {
  if (markerFeature)
    map.getView().animate({
      center: markerFeature.getGeometry().getCoordinates(),
      zoom: 16,
      duration: 300
    });
  else
    getCurrentOnceAndStartWatch();
});

btnFollow.addEventListener('click', () => {
  following = !following;
  btnFollow.textContent = following ? '‚ñ∂ Follow: ON' : '‚ñ∂ Follow: OFF';
});

getCurrentOnceAndStartWatch();
</script>

</body>
</html>